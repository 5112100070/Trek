<!DOCTYPE html>
<html lang="en">

  {{ template "dashboard-header.tmpl" .}}

    <body class="nav-fixed">
      {{ template "dashboard-notifcenter.tmpl" .}}   

      <div id="layoutSidenav">
          <!-- Sidebar -->
          {{ template "dashboard-sidebar.tmpl" .}}
          <div id="layoutSidenav_content">
                <main>
                    <div class="page-header">
                        <div class="container-fluid">
                            <div class="page-header-content py-2">
                                <div id="success-alert" class="alert alert-success hide" role="alert"></div>
                                <div id="failed-alert" class="alert alert-danger hide" role="alert"></div>
                                <div class="page-header-title" style="font-size:1rem;"> 
                                    <ol class="breadcrumb mt-1 mb-0">
                                        <li class="breadcrumb-item">
                                            <a href="#" style="color:black;" onclick="javascript:window.location='/dashboard/orders'">Order</a>
                                        </li>
                                        <li class="breadcrumb-item active">#{{ .order.ID }}</li>
                                    </ol>
                                </div>
                                <div class="page-header-subtitle">
                                    <button class="btn btn-primary btn-sm" type="button" data-toggle="modal" data-target="#delivery">Edit</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="container-fluid mb-4" style="height: 100%;">
                        <ul class="progressbar">
                            <li
                            {{ if eq .order.Status 1 }} class="stop" {{ end }}
                            {{ if gt .order.Status 1 }} class="active" {{ end }}
                            >Konfirmasi</li>
                            <li>Pickup</li>
                            <li>Delivering</li>
                            <li>Done</li>
                        </ul>
                    </div>

                    <div class="container-fluid mt-4" style="margin-top: 4.5rem !important;">
                            <div class="row">
                                <div class="col-lg-12">
                                    <div id="sizing">
                                        <div class="card mb-4 mt-4">
                                            <div class="card-header text-dark">
                                                <div class="col-6">
                                                    Order #{{ .order.ID }}
                                                    
                                                    {{ if eq .order.Status 0 }}
                                                    <span class="badge badge-primary text-wrap ml-2">
                                                        New
                                                    </span>
                                                    {{ end }}

                                                    {{ if eq .order.Status 1 }}
                                                    <span class="badge badge-danger text-wrap ml-2">
                                                        Rejected
                                                    </span>
                                                    {{ end }}
                                                    
                                                    {{ if eq .order.Status 2 }}
                                                    <span class="badge badge-primary text-wrap ml-2">
                                                        Approved
                                                    </span>
                                                    {{ end }}

                                                </div>
                                                <div class="col-6">
                                                    <div class="float-right">
                                                        {{ if eq .order.Status 0 }}
                                                        <button class="btn btn-success btn-sm" type="button" data-toggle="modal" data-target="#konfirmasi">Approved</button> 
                                                        {{ end }}

                                                        <button class="btn btn-red btn-sm" type="button" data-toggle="modal" data-target="#reject-order">Cancel</button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <div class="position-relative">
                                                    <div class="row align-items-center justify-content-between">
                                                        <div class="col position-relative ">
                                                           <div class="row mb-3">
                                                                <div class="col-4 info" >
                                                                   <p >
                                                                    Airway bill
                                                                   </p >
                                                                   <p style="color:black;" class="font-weight-bold" >
                                                                       <h1>
                                                                            {{ .order.AWB }}
                                                                       </h1>
                                                                   </p>
                                                                </div>
                                                                <div class="col-4 info"> 
                                                                    <p >
                                                                        Klien
                                                                       </p>
                                                                       <p style="font-weight: 500;color: black;">
                                                                            {{ .order.CompanyName }}
                                                                       </p>
                                                                </div>
                                                                <div class="col-4 info"> 
                                                                    <p>
                                                                        Order Created
                                                                       </p>
                                                                       <p style="font-weight: 500;color: black;">
                                                                          <span class="text-grey-500">
                                                                              {{ .order.DeliveryName }}
                                                                          </span>
                                                                          <br>
                                                                            {{ .order.CreateTimeStr }}
                                                                       </p>
                                                                </div>
                                                           </div>
                                                           <div class="row mb-3">
                                                            <div class="col-4 info">
                                                                <p >
                                                                    Nama Penerima
                                                                    </p >
                                                                    <p style="color:black;" class="font-weight-bold" >
                                                                        {{ .order.ReceiverName }}
                                                                    </p>
                                                                    <p style="color:black;">
                                                                        {{ .order.ReceiverPhoneNumber }}
                                                                    </p>
                                                             </div>
                                                            <div class="col-8 info" >
                                                                <p >
                                                                Alamat
                                                                </p >
                                                                <p style="color:black;" class="font-weight-bold" >
                                                                    {{ .order.ReceiverAddress }}
                                                                    <p style="color:black;">
                                                                        {{ .order.ReceiverNotes }}
                                                                    </p>
                                                                </p>
                                                             </div>
                                                           </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- Pickup Field Generated from here -->
                                            <div class="card-header" style="color:black;">
                                                <div class="col-6">Pengambilan</div>
                                                {{ if eq .order.Status 2 }} 
                                                <div class="col-6 ">
                                                    <div class="dropdown float-right">
                                                        <button class="btn btn-green btn-sm dropdown-toggle" id="dispatch-menu" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                            Dispatch
                                                        </button>
                                                        <div class="dropdown-menu animated--fade-in" aria-labelledby="dispatch-menu">
                                                            <a class="dropdown-item" data-toggle="modal" data-target="#dispatch-fulfilment-center" style="cursor: pointer;">Fullfilment Center</a>
                                                            <a class="dropdown-item" data-toggle="modal" data-target="#dispatch-pickup" style="cursor: pointer;">Driver</a>
                                                        </div>
                                                    </div>      
                                                </div>
                                                {{ end }}
                                            </div>
                                            {{ $orderDetail := .order }}
                                            {{ range $indexPickup, $pickup := .order.Pickups }}
                                            <div class="card-body">
                                               <div class= "col-lg-12 p-4 mb-4" style="background-color:#e9edf3;">
                                                    <div class="position-relative">
                                                        <div class="row">
                                                            <div class="col-6">
                                                                <span class="badge badge-primary text-wrap ml-2">
                                                                    Picking up
                                                                </span>
                                                            </div>

                                                            {{ if eq $orderDetail.Status 3 }} 
                                                            <div class="col-6 ">
                                                                <div class="dropdown float-right">
                                                                    <button class="btn btn-green btn-sm dropdown-toggle" id="pickup-menu" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                                        {{ if eq $pickup.Status 0 }}
                                                                        Assign to driver
                                                                        {{ end }}
                                                                        {{ if eq $pickup.Status 1 2 }}
                                                                        Update
                                                                        {{ end }}
                                                                    </button>
                                                                    <div class="dropdown-menu animated--fade-in" aria-labelledby="pickup-menu">
                                                                        <a class="dropdown-item" style="cursor: pointer;" onclick="javascript:showModalPickUp({{ $orderDetail.ID }}, {{ $pickup.ID }})">
                                                                            {{ if eq $pickup.Status 0 2 }}
                                                                            Input Driver's Data
                                                                            {{ end }}
                                                                            {{ if eq $pickup.Status 1 }}
                                                                            Change Driver
                                                                            {{ end }}
                                                                        </a>
                                                                        {{ if ne $pickup.Status 2 }}
                                                                        <a class="dropdown-item" style="cursor: pointer;" onclick="javascript:showModalRejectPickUp({{ $pickup.ID }}, {{ $pickup.Name }}, {{ $pickup.Address }})">Reject</a>
                                                                        {{ end }}
                                                                        {{ if eq $pickup.Status 1 }}
                                                                        <a class="dropdown-item" href="javascript:void(0);" style="cursor: pointer;">Finish</a>
                                                                        {{ end }}
                                                                    </div>
                                                                </div>      
                                                            </div>
                                                            {{ end }}
                                                        </div>

                                                        <div class="row align-items-center justify-content-between">
                                                            <div class="col position-relative ">
                                                            <div class="row mb-3">
                                                                <div class="col-4 info">
                                                                    <p >
                                                                        Nama Penerima
                                                                        </p >
                                                                        <p style="color:black;" class="font-weight-bold" >
                                                                            {{ $pickup.Name }}
                                                                        </p>
                                                                        <p style="color:black;">
                                                                            {{ $pickup.PhoneNumber }}
                                                                        </p>
                                                                </div>
                                                                <div class="col-8 info" >
                                                                    <p >
                                                                    Alamat
                                                                    </p >
                                                                    <p style="color:black;" class="font-weight-bold" >
                                                                        {{ $pickup.Address }}
                                                                        <p style="color:black;">
                                                                            {{ $pickup.Notes }}
                                                                        </p>
                                                                    </p>
                                                                </div>
                                                                <div class="datatable table-responsive mt-4">
                                                                    <table class="table table-bordered table-hover" id="dataTable" width="100%" cellspacing="0">
                                                                        <thead>
                                                                            <tr>
                                                                                <th>Nama produk</th>
                                                                                <th>Deskripsi produk</th>
                                                                                <th>Jumlah</th>
                                                                                <th>Aksi</th>
                                                                            </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                            {{ range $indexItem, $item := $pickup.Items }}
                                                                            <tr>
                                                                                <td>
                                                                                    {{ $item.Name }}
                                                                                </td>
                                                                                <td> 
                                                                                    {{ $item.Notes }}
                                                                                </td>
                                                                                <td>
                                                                                    {{ $item.Quantity }} {{ $item.UnitName }}
                                                                                </td>
                                                                                <td>
                                                                                    <button class="btn btn-datatable btn-icon btn-transparent-dark"><i data-feather="trash-2"></i></button>
                                                                                </td>
                                                                            </tr>
                                                                            {{ end }}
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                            </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            {{ end }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                    </div>
                </main>
                <!-- Footer -->
                {{ template "dashboard-footer.tmpl" .}}
          </div>
      </div>
      
      <!-- Modal -->
      <div id="loading-pop-up" class="modal-loading">
        <div class="lds-facebook"><div></div><div></div><div></div></div>
      </div>
      <!-- modal konfirmasi -->
      <div class="modal fade" id="konfirmasi" data-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="staticBackdropLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="staticBackdropLabel">Konfirmasi Order</h5>
                        <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">×</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <h6>
                            Masukan Airwaybill
                        </h6>
                        <div class="form-group">
                            <label for="exampleFormControlInput1">Airwaybill</label>
                            <input id="airwaybill" class="form-control" type="name" />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-red btn-sm" type="button" data-dismiss="modal">Close</button>
                        <button class="btn btn-success btn-sm" type="button" onclick="javascript:handleApproveOrder()">Submit</button>
                    </div>
                </div>
            </div>
      </div>

      <!-- modal konfirmasi reject order -->
      <div class="modal fade" id="reject-order" data-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="staticBackdropLabel">Konfirmasi Pembatalan Order</h5>
                    <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    Apakah anda yakin untuk melakukan pembatalan order ?
                </div>
                <div class="modal-footer">
                    <button class="btn btn-red btn-sm" type="button" data-dismiss="modal">Tidak</button>
                    <button class="btn btn-success btn-sm" type="button" onclick="javascript:handleRejectOrder()">Ya, Batalkan Order !</button>
                </div>
            </div>
        </div>
      </div>

      <!-- modal konfirmasi dispatch by pickup driver -->
      <div class="modal fade" id="dispatch-pickup" data-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="dispatch-pickup-label" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="dispatch-pickup-label">Confirmation Dispatch To Driver</h5>
                    <button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                </div>
                <div class="modal-body">
                    Apakah anda yakin untuk melakukan dispatch order ke <span style="font-weight: bold;">Driver</span> ?
                </div>
                <div class="modal-footer">
                    <button class="btn btn-red btn-sm" type="button" data-dismiss="modal">Tidak</button>
                    <a class="btn btn-success btn-sm" onclick="javascript:handleDispatchOrder('DISPATCH_TO_FULFILMENT_DRIVER')" type="button" style="text-decoration: none; color: black;">Dispatch To Driver</a>
                </div>
            </div>
        </div>
    </div>

    <!-- modal konfirmasi dispatch by to fulfilment center -->
    <div class="modal fade" id="dispatch-fulfilment-center" data-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="dispatch-fulfilment-center" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmation Dispatch To Fulfilment Center</h5>
                    <button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                </div>
                <div class="modal-body">
                    Apakah anda yakin untuk melakukan dispatch order ke <span style="font-weight: bold;">Fulfilment Center</span> ?
                </div>
                <div class="modal-footer">
                    <button class="btn btn-red btn-sm" type="button" data-dismiss="modal">Tidak</button>
                    <a class="btn btn-success btn-sm" type="button" onclick="javascript:handleDispatchOrder('DISPATCH_TO_FULFILMENT_CENTER')" style="text-decoration: none; color: black;">
                        Dispatch To Fulfilment Center
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- modal konfirmasi Pickup By Driver -->
    <div class="modal fade" id="modal-pickup-driver" data-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="modal-pickup-driver-label" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-pickup-driver-label">Assign Driver</h5>
                    <button class="close" type="button" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="pickup-driver-name">Driver name</label>
                        <input class="form-control" id="pickup-driver-name" type="text" />
                    </div>
                    <div class="form-group">
                        <label for="pickup-driver-phone">Driver phone</label>
                        <input class="form-control" id="pickup-driver-phone" type="text" />
                    </div>
                    <input class="hide" id="pickup-pickup-id" />
                </div>
                <div class="modal-footer">
                    <button class="btn btn-red btn-sm" type="button" data-dismiss="modal">Close</button>
                    <a class="btn btn-success btn-sm" type="button" onclick="javascript:handlePickUpOrder()" style="text-decoration: none; color: black;">
                        Assign To Driver!
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- modal konfirmasi reject pick up -->
    <div class="modal fade" id="reject-pick-up" data-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="reject-pick-up-label" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reject-pick-up-label"></h5>
                    <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body" id="reject-pick-up-body">
                    Apakah anda yakin untuk melakukan pembatalan pick up atas nama: , dengan alamat: ?
                </div>

                <input class="hide" id="reject-pick-up-id" />
                
                <div class="modal-footer">
                    <button class="btn btn-red btn-sm" type="button" data-dismiss="modal">Tidak</button>
                    <button class="btn btn-success btn-sm" type="button" onclick="javascript:handleRejectPickUp()">Ya, Batalkan Pick Up !</button>
                </div>
            </div>
        </div>
      </div>

    </body>
    {{ template "default-script-dashboard.tmpl" .}}

    <script>
         function togglePickupField(comp){
            $(comp).css("display", "none");
        }

        function handleApproveOrder(){
            var url = new URL(window.location.href);
            var orderID = url.searchParams.get("id");
            var awb = $("#airwaybill").val();

            StartLoading();

            var fd = new FormData();
            fd.append('order_id', orderID);
            fd.append('awb', awb);
            
            var promise = $.ajax({
                url: base_url + '/admin/approve-order',
                type: 'POST',
                data: fd,
                processData: false,
                contentType: false,
                cache : false,
                xhrFields: {
                    withCredentials: true
                }
            });
            
            $('#konfirmasi').modal("toggle");   

            promise.done(function(response){
                response = response.data;

                FinishLoading();
                if(response.error!=null){
                    setError(true, response.error.detail);
                    gotoTop();
                } else {
                    window.location.reload();    
                }
            }).fail(function(response){
                FinishLoading();
                var status = response.status;
                setError(true, response.responseJSON.data);
            });
        }

        function handleRejectOrder(){
            var url = new URL(window.location.href);
            var orderID = url.searchParams.get("id");

            StartLoading();

            var fd = new FormData();
            fd.append('order_id', orderID);
            
            var promise = $.ajax({
                url: base_url + '/admin/reject-order',
                type: 'POST',
                data: fd,
                processData: false,
                contentType: false,
                cache : false,
                xhrFields: {
                    withCredentials: true
                }
            });
            
            $('#reject-order').modal("toggle");

            promise.done(function(response){
                response = response.data;

                FinishLoading();
                if(response.error!=null){
                    setError(true, response.error.detail);
                    gotoTop();
                } else {
                    window.location.reload();
                }
            }).fail(function(response){
                FinishLoading();
                var status = response.status;
                setError(true, response.responseJSON.data);
            });
        }

        function handleDispatchOrder(action){
            var url = new URL(window.location.href);
            var orderID = url.searchParams.get("id");

            StartLoading();

            var fd = new FormData();
            fd.append('order_id', orderID);
            fd.append('action', action);

            var promise = $.ajax({
                url: base_url + '/admin/dispatch-order',
                type: 'POST',
                data: fd,
                processData: false,
                contentType: false,
                cache : false,
                xhrFields: {
                    withCredentials: true
                }
            });
            
            if(action == "DISPATCH_TO_FULFILMENT_CENTER"){
                $('#dispatch-fulfilment-center').modal("toggle");
            } else if(action == "DISPATCH_TO_FULFILMENT_DRIVER"){
                $('#dispatch-pickup').modal("toggle");
            }

            promise.done(function(response){
                response = response.data;

                FinishLoading();
                if(response.error!=null){
                    setError(true, response.error.detail);
                    gotoTop();
                } else {
                    window.location.reload();   
                }
            }).fail(function(response){
                FinishLoading();
                var status = response.status;
                setError(true, response.responseJSON.data);
            });
        }

        function handlePickUpOrder(){
            $('#modal-pickup-driver').modal("toggle");

            var url = new URL(window.location.href);
            var orderID = url.searchParams.get("id");
            var pickupID = $("#pickup-pickup-id").val();
            var driverName = $("#pickup-driver-name").val();
            var driverPhone = $("#pickup-driver-phone").val();             

            StartLoading();

            var fd = new FormData();
            fd.append('order_id', orderID);
            fd.append('pickup_id', pickupID);
            fd.append('driver_name', driverName);
            fd.append('driver_phone', driverPhone);

            var promise = $.ajax({
                url: base_url + '/admin/pickup-item-order',
                type: 'POST',
                data: fd,
                processData: false,
                contentType: false,
                cache : false,
                xhrFields: {
                    withCredentials: true
                }
            });
            
            promise.done(function(response){
                response = response.data;

                FinishLoading();
                if(response.error!=null){
                    setError(true, response.error.detail);
                    gotoTop();
                } else {
                    window.location.reload();
                }
            }).fail(function(response){
                FinishLoading();
                var status = response.status;
                setError(true, response.responseJSON.data);
            });
        }

        function handleRejectPickUp(){
            var url = new URL(window.location.href);
            var orderID = url.searchParams.get("id");
            var pickUpID = $("#reject-pick-up-id").val();

            StartLoading();

            var fd = new FormData();
            fd.append('order_id', orderID);
            fd.append("pickup_id", pickUpID);

            var promise = $.ajax({
                url: base_url + '/admin/reject-pickup',
                type: 'POST',
                data: fd,
                processData: false,
                contentType: false,
                cache : false,
                xhrFields: {
                    withCredentials: true
                }
            });
            
            $('#reject-pick-up').modal("toggle");

            promise.done(function(response){
                response = response.data;

                FinishLoading();
                if(response.error!=null){
                    setError(true, response.error.detail);
                    gotoTop();
                } else {
                    window.location.reload();   
                }
            }).fail(function(response){
                FinishLoading();
                var status = response.status;
                setError(true, response.responseJSON.data);
            });
        }

        function showModalRejectPickUp(pickupID, recieverName, recieverAddress){
            $("#reject-pick-up").modal("show");

            // add bold html tag
            recieverName = "<b>" + recieverName + "</b>";
            recieverAddress = "<b>" + recieverAddress + "</b>";

            // add pickup id on Label
            $("#reject-pick-up-label").html("Konfirmasi Pembatalan Pick Up #"+pickupID);
            $("#reject-pick-up-id").val(pickupID);

            // add generate confirmation text
            var strName = "Apakah anda yakin untuk melakukan pembatalan pick up atas nama: "+recieverName;
            var strAddr = " , dengan alamat: "+recieverAddress+" ?";
            
            $("#reject-pick-up-body").html(strName+strAddr);
        }

        function showModalPickUp(orderID, pickupID){
            $('#modal-pickup-driver').modal("show");

            // add pickup id on input for request data
            $('#pickup-pickup-id').val(pickupID);
        }

        function setError(isShow, message = "") {
            if (isShow) {
                $("#failed-alert").removeClass("hide");
                $("#failed-alert").html(message);
                $("#success-alert").addClass("hide");

                gotoTop();
            } else {
                $("#failed-alert").addClass("hide");
                $("#failed-alert").html("");
            }
        }

        function gotoTop(){
            document.body.scrollTop = 0;
            document.documentElement.scrollTop = 0;
        }
    </script>
    <link href="/css/progress.css" rel="stylesheet">
</html>